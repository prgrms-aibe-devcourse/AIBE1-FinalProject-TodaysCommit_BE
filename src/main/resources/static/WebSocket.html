<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>1-ëŒ€-1 ì±„íŒ… ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</title>
  <style>
    body{font-family:sans-serif;max-width:600px;margin:40px auto;background:#f5f5f5}
    .container{background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    input,button{padding:8px;font-size:14px;border:1px solid #ddd;border-radius:4px}
    button{background:#007bff;color:white;cursor:pointer;border:none}
    button:hover:not(:disabled){background:#0056b3}
    button:disabled{background:#ccc;cursor:not-allowed}
    #log{margin-top:15px;height:300px;overflow-y:auto;border:1px solid #ddd;font:12px/1.4 monospace;padding:10px;background:#fafafa;border-radius:4px}
    .message{margin:5px 0;padding:8px;border-radius:8px;max-width:80%;word-break:break-word}
    .me{background:#007bff;color:white;margin-left:auto;text-align:right}
    .peer{background:#e9ecef;color:#333}
    .system{color:#666;font-style:italic;text-align:center;background:none;padding:4px}
    .connection-controls{margin:10px 0;display:flex;gap:10px;align-items:center}
    .form-group{margin:10px 0}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-group input{width:100%;box-sizing:border-box}
    .send-controls{display:flex;gap:10px;margin-top:10px}
    .send-controls input{flex:1}
    .status{padding:5px 10px;border-radius:4px;font-size:12px;font-weight:bold}
    .status.connected{background:#d4edda;color:#155724}
    .status.disconnected{background:#f8d7da;color:#721c24}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div class="container">
  <h2>âš¡ 1-ëŒ€-1 ì±„íŒ… ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h2>

  <div class="form-group">
    <label>WebSocket URL:</label>
    <input id="wsUrl" value="ws://localhost:8080/v1/users/chat">
  </div>

  <div class="form-group">
    <label>Room ID:</label>
    <input id="roomId" placeholder="ì±„íŒ…ë°© ID ì…ë ¥">
  </div>

  <div class="connection-controls">
    <button id="connectBtn">ì—°ê²°</button>
    <button id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
    <span id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
  </div>

  <div class="send-controls">
    <input id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
    <button id="sendBtn" disabled>ì „ì†¡</button>
  </div>

  <div id="log"></div>
</div>

<script>
  const $ = id => document.getElementById(id);
  let stomp = null;
  let currentRoom = null;

  function log(text, cls='system') {
    const el = document.createElement('div');
    el.className = `message ${cls}`;
    el.textContent = text;
    $("log").appendChild(el);
    $("log").scrollTop = $("log").scrollHeight;
  }

  function setUi(connected) {
    $("connectBtn").disabled = connected;
    $("disconnectBtn").disabled = !connected;
    $("sendBtn").disabled = !connected;
    $("msg").disabled = !connected;
    $("wsUrl").disabled = connected;
    $("roomId").disabled = connected;
    const s = $("status");
    if (connected) { s.textContent='ì—°ê²°ë¨'; s.className='status connected'; }
    else           { s.textContent='ì—°ê²° ì•ˆë¨'; s.className='status disconnected'; }
  }

  function connect() {
    if (stomp?.connected) { log('ì´ë¯¸ ì—°ê²°ë¨'); return; }
    const wsUrl = $("wsUrl").value.trim();
    const roomId = $("roomId").value.trim();
    if (!roomId) { alert('Room ID ì…ë ¥'); return; }
    currentRoom = roomId;

    log('ì—°ê²° ì‹œë„â€¦');
    const sock = new WebSocket(wsUrl);
    stomp = Stomp.over(sock);
    stomp.debug = () => {};

    // JWTê°€ ì¿ í‚¤ì— ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´, ë³„ë„ í—¤ë” ì¶”ê°€ ì—†ì´ ì „ì†¡ë¨
    stomp.connect({}, frame => {
      log('âœ… ì—°ê²°ë¨');
      setUi(true);

      // êµ¬ë… ì„¤ì •
      stomp.subscribe('/user/queue/chat', onMessage);
      log(`ì±„íŒ…ë°© ${currentRoom} ì…ì¥`, 'system');
    }, err => {
      console.error('CONNECT ERR:', err);
      log('âŒ ì—°ê²° ì‹¤íŒ¨'); setUi(false);
    });

    sock.onclose = () => { log('ğŸ”Œ ì—°ê²° ì¢…ë£Œ'); setUi(false); };
    sock.onerror = e => { console.error(e); log('âŒ WS ì—ëŸ¬'); };
  }

  function onMessage(msg) {
    try {
      const data = JSON.parse(msg.body);
      if (data.roomId !== currentRoom) return;
      render(data);
    } catch (e) {
      console.error('PARSE ERR:', e);
    }
  }

  function render(data) {
    const isMe = data.isMe;
    const cls  = isMe ? 'me' : 'peer';
    const who  = isMe ? 'ë‚˜' : 'ìƒëŒ€';
    const time = new Date(data.sentAt).toLocaleTimeString();
    const el = document.createElement('div');
    el.className = `message ${cls}`;
    el.innerHTML = `<strong>${who}</strong> <small>${time}</small><br>${data.message}`;
    $("log").appendChild(el);
    $("log").scrollTop = $("log").scrollHeight;
  }

  function sendMessage() {
    if (!stomp?.connected) { alert('ë¨¼ì € ì—°ê²°'); return; }
    const txt = $("msg").value.trim();
    if (!txt) { alert('ë©”ì‹œì§€ ì…ë ¥'); return; }
    const payload = { roomId: currentRoom, behaviorType:'TALK', message: txt, sentAt: new Date().toISOString() };
    stomp.send('/pub/chat/message', {}, JSON.stringify(payload));
    $("msg").value = '';
  }

  $("connectBtn").onclick    = connect;
  $("disconnectBtn").onclick = () => { stomp?.disconnect(); setUi(false); };
  $("sendBtn").onclick       = sendMessage;
  $("msg").onkeypress         = e => { if(e.key==='Enter') sendMessage(); };

  setUi(false);
</script>
</body>
</html>
