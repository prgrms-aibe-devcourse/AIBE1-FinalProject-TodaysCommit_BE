<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>1-대-1 채팅 실시간 테스트</title>
  <style>
    body{font-family:sans-serif;max-width:600px;margin:40px auto;background:#f5f5f5}
    .container{background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    input,button{padding:8px;font-size:14px;border:1px solid #ddd;border-radius:4px}
    button{background:#007bff;color:white;cursor:pointer;border:none}
    button:hover:not(:disabled){background:#0056b3}
    button:disabled{background:#ccc;cursor:not-allowed}
    #log{margin-top:15px;height:300px;overflow-y:auto;border:1px solid #ddd;font:12px/1.4 monospace;padding:10px;background:#fafafa;border-radius:4px}
    .message{margin:5px 0;padding:8px;border-radius:8px;max-width:80%;word-break:break-word}
    .me{background:#007bff;color:white;margin-left:auto;text-align:right}
    .peer{background:#e9ecef;color:#333}
    .system{color:#666;font-style:italic;text-align:center;background:none;padding:4px}
    .connection-controls{margin:10px 0;display:flex;gap:10px;align-items:center}
    .form-group{margin:10px 0}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-group input{width:100%;box-sizing:border-box}
    .send-controls{display:flex;gap:10px;margin-top:10px}
    .send-controls input{flex:1}
    .status{padding:5px 10px;border-radius:4px;font-size:12px;font-weight:bold}
    .status.connected{background:#d4edda;color:#155724}
    .status.disconnected{background:#f8d7da;color:#721c24}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div class="container">
  <h2>⚡ 1-대-1 채팅 실시간 테스트</h2>

  <div class="form-group">
    <label>WebSocket URL:</label>
    <input id="wsUrl" value="ws://localhost:8080/v1/users/chat">
  </div>

  <div class="form-group">
    <label>Room ID:</label>
    <input id="roomId" placeholder="채팅방 ID 입력">
  </div>

  <div class="connection-controls">
    <button id="connectBtn">연결</button>
    <button id="disconnectBtn" disabled>연결 해제</button>
    <span id="status" class="status disconnected">연결 안됨</span>
  </div>

  <div class="send-controls">
    <input id="msg" placeholder="메시지를 입력하세요..." disabled>
    <button id="sendBtn" disabled>전송</button>
  </div>

  <div id="log"></div>
</div>

<script>
  const $ = id => document.getElementById(id);
  let stomp = null;
  let currentRoom = null;

  function log(text, cls='system') {
    const el = document.createElement('div');
    el.className = `message ${cls}`;
    el.textContent = text;
    $("log").appendChild(el);
    $("log").scrollTop = $("log").scrollHeight;
  }

  function setUi(connected) {
    $("connectBtn").disabled = connected;
    $("disconnectBtn").disabled = !connected;
    $("sendBtn").disabled = !connected;
    $("msg").disabled = !connected;
    $("wsUrl").disabled = connected;
    $("roomId").disabled = connected;
    const s = $("status");
    if (connected) { s.textContent='연결됨'; s.className='status connected'; }
    else           { s.textContent='연결 안됨'; s.className='status disconnected'; }
  }

  function connect() {
    if (stomp?.connected) { log('이미 연결됨'); return; }
    const wsUrl = $("wsUrl").value.trim();
    const roomId = $("roomId").value.trim();
    if (!roomId) { alert('Room ID 입력'); return; }
    currentRoom = roomId;

    log('연결 시도…');
    const sock = new WebSocket(wsUrl);
    stomp = Stomp.over(sock);
    stomp.debug = () => {};

    // JWT가 쿠키에 설정되어 있다면, 별도 헤더 추가 없이 전송됨
    stomp.connect({}, frame => {
      log('✅ 연결됨');
      setUi(true);

      // 구독 설정
      stomp.subscribe('/user/queue/chat', onMessage);
      log(`채팅방 ${currentRoom} 입장`, 'system');
    }, err => {
      console.error('CONNECT ERR:', err);
      log('❌ 연결 실패'); setUi(false);
    });

    sock.onclose = () => { log('🔌 연결 종료'); setUi(false); };
    sock.onerror = e => { console.error(e); log('❌ WS 에러'); };
  }

  function onMessage(msg) {
    try {
      const data = JSON.parse(msg.body);
      if (data.roomId !== currentRoom) return;
      render(data);
    } catch (e) {
      console.error('PARSE ERR:', e);
    }
  }

  function render(data) {
    const isMe = data.isMe;
    const cls  = isMe ? 'me' : 'peer';
    const who  = isMe ? '나' : '상대';
    const time = new Date(data.sentAt).toLocaleTimeString();
    const el = document.createElement('div');
    el.className = `message ${cls}`;
    el.innerHTML = `<strong>${who}</strong> <small>${time}</small><br>${data.message}`;
    $("log").appendChild(el);
    $("log").scrollTop = $("log").scrollHeight;
  }

  function sendMessage() {
    if (!stomp?.connected) { alert('먼저 연결'); return; }
    const txt = $("msg").value.trim();
    if (!txt) { alert('메시지 입력'); return; }
    const payload = { roomId: currentRoom, behaviorType:'TALK', message: txt, sentAt: new Date().toISOString() };
    stomp.send('/pub/chat/message', {}, JSON.stringify(payload));
    $("msg").value = '';
  }

  $("connectBtn").onclick    = connect;
  $("disconnectBtn").onclick = () => { stomp?.disconnect(); setUi(false); };
  $("sendBtn").onclick       = sendMessage;
  $("msg").onkeypress         = e => { if(e.key==='Enter') sendMessage(); };

  setUi(false);
</script>
</body>
</html>
